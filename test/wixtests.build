<?xml version="1.0" encoding="utf-8"?>
<project name="WixTests" default="wixtests.inc" xmlns="http://nant.sf.net/release/0.85-rc3/nant.xsd">
  <description>
    Copyright (c) Microsoft Corporation.  All rights reserved.
    
    The use and distribution terms for this software are covered by the
    Common Public License 1.0 (http://opensource.org/licenses/cpl.php)
    which can be found in the file CPL.TXT at the root of this distribution.
    By using this software in any fashion, you are agreeing to be bound by
    the terms of this license.
    
    You must not remove this notice, or any other, from this software.

    wixtests.build - Builds the tests solution
  </description>
  <!--
  //////////////////////////////////////////////////////////////////////////////////////////////////
  // Properties
  //////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  <!-- Include the global build properties -->
  <include buildfile="..\wix.include" unless="${property::exists('wix.properties.defined')}" />
  <!-- Check if VS Test is installed -->
  <readregistry property="vspro.10.0" key="SOFTWARE\Microsoft\VisualStudio\10.0\Setup\VS\Pro\ProductDir" hive="LocalMachine" failonerror="false" />
  <readregistry property="vsta.10.0" key="SOFTWARE\Microsoft\VisualStudio\10.0\Setup\VS\VSTA\ProductDir" hive="LocalMachine" failonerror="false" />
  <readregistry property="vstd.10.0" key="SOFTWARE\Microsoft\VisualStudio\10.0\Setup\VS\VSTD\ProductDir" hive="LocalMachine" failonerror="false" />
  <readregistry property="vsts.10.0" key="SOFTWARE\Microsoft\VisualStudio\10.0\Setup\VS\VSTS\ProductDir" hive="LocalMachine" failonerror="false" />
  <readregistry property="vstt.10.0" key="SOFTWARE\Microsoft\VisualStudio\10.0\Setup\VS\VSTT\ProductDir" hive="LocalMachine" failonerror="false" />

  <if test="${property::exists('vspro.10.0') or property::exists('vsta.10.0') or property::exists('vstd.10.0') or property::exists('vsts.10.0') or property::exists('vstt.10.0')}">
    <property name="vstesttools.installed" value="installed" />
    <echo level="Info" message="Pre-requisite Check Passed: Visual Studio 10.0 Test Tools are installed." />
  </if>
  <if test="${not property::exists('vstesttools.installed')}">
    <echo level="Info" message="Pre-requisite Check Failed: Visual Studio 10.0 Test Tools are not installed." />
  </if>

  <!-- Check if .NET Framework 4.0 is installed -->
  <readregistry property="netfx4full" key="SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full\InstallPath" hive="LocalMachine" failonerror="false" />

  <if test="${property::exists('netfx4full')}">
    <property name="netfx4full.installed" value="installed" />
    <echo level="Info" message="Pre-requisite Check Passed: .Net Framework 4.0 Full is installed." />
  </if>

  <if test="${not property::exists('netfx4full')}">
    <echo level="Info" message="Pre-requisite Check Failed: .Net Framework 4.0 Full is not installed." />
  </if>

  <!-- Check if Microsoft.Web.Administration.dll is installed -->
  <property name="Microsoft.Web.Administration.dll.FullPath" value="${environment::get-variable('windir')}\System32\inetsrv\Microsoft.Web.Administration.dll" />
  <property name="Microsoft.Web.Administration.dll.Exists" value="${file::exists(Microsoft.Web.Administration.dll.FullPath)}" />
  <!--if test="${file::exists(Microsoft.Web.Administration.dll.FullPath)}"-->
  <if test="${Microsoft.Web.Administration.dll.Exists}">
    <echo level="Info" message="Pre-requisite Check Passed: Microsoft.Web.Administration.dll is installed." />
  </if>
  <if test="${not Microsoft.Web.Administration.dll.Exists}">
    <echo level="Info" message="Pre-requisite Check Failed: Microsoft.Web.Administration.dll is not installed." />
  </if>

  <!--
  //////////////////////////////////////////////////////////////////////////////////////////////////
  // Targets
  //////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <!-- Wix test targets -->
  <target name="wixtests" depends="wixtests.inc" />
  <target name="wixtests.build" depends="wixtests.clean, wixtests.inc" description="Peforms a full rebuild (clean then build)"/>
  <target name="wixtests.clean" depends="migrateQTests.clean, wixtestsmain.clean, IISExtensionTests.clean" description="Cleans the build"/>
  <target name="wixtests.inc" depends="migrateQTests.inc, wixtestsmain.inc, IISExtensionTests.inc" description="Performs an incremental build"/>
  
  <!-- Build -->
  <target name="IISExtensionTests.build" depends="IISExtensionTests.clean, IISExtensionTests.inc" description="Peforms a full rebuild (clean then build)">
  </target>
  <target name="migrateQTests.build" depends="migrateQTests.clean, migrateQTests.inc" description="Peforms a full rebuild (clean then build)">
  </target>
  <target name="wixtestsmain.build" depends="wixtestsmain.clean, wixtestsmain.inc" description="Peforms a full rebuild (clean then build)">
  </target>
 
  <!-- Clean -->
  <target name="IISExtensionTests.clean" if="${property::exists('netfx4full')}" description="Cleans the IISExtension tests">
    <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
      <arg value="/property:OutputPath=${dir.root}build\${flavor}\x86" />
      <arg value="/property:Configuration=Debug" if="${debug}" />
      <arg value="/property:Configuration=Release" if="${ship}" />
      <arg value="/property:Platform=Any CPU" />
      <arg value="/target:Clean" />
      <arg file="${dir.wixroot.test}\IISExtensionTests\IISExtensionTests.csproj" />
    </exec>
  </target>
  <target name="migrateQTests.clean" if="${property::exists('netfx4full')}" description="Cleans the build">
    <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
      <arg value="/property:OutputPath=${dir.root}build\${flavor}\x86" />
      <arg value="/property:Configuration=Debug" if="${debug}" />
      <arg value="/property:Configuration=Release" if="${ship}" />
      <arg value="/property:Platform=Any CPU" />
      <arg value="/target:Clean" />
      <arg file="${dir.wixroot.test}\MigrateQTests\MigrateQTests.csproj" />
    </exec>
  </target>
  <target name="wixtestsmain.clean" if="${property::exists('netfx4full')}" description="Cleans the build">
    <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
      <arg value="/property:Configuration=Debug" if="${debug}" />
      <arg value="/property:Configuration=Release" if="${ship}" />
      <arg value="/property:Platform=Any CPU" />
      <arg value="/target:Clean" />
      <arg file="${dir.wixroot.test}\wixtests.sln" />
    </exec>
  </target>
 
  <!-- Inc -->
  <target name="IISExtensionTests.inc" depends="wixtestsmain.inc" if="${property::exists('netfx4full')}" description="Performs an incremental build">
    <if test="${Microsoft.Web.Administration.dll.Exists}">
      <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
        <arg value="/property:OutputPath=${dir.root}build\${flavor}\x86" />
        <arg value="/property:Configuration=Debug" if="${debug}" />
        <arg value="/property:Configuration=Release" if="${ship}" />
        <arg value="/property:Platform=Any CPU" />
        <arg value="/target:Build" />
        <arg file="${dir.wixroot.test}\IISExtensionTests\IISExtensionTests.csproj" />
      </exec>
    </if>
  </target>
  <target name="migrateQTests.inc" if="${property::exists('netfx4full')}" description="Performs an incremental build">
    <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
      <arg value="/property:OutputPath=${dir.root}build\${flavor}\x86" />
      <arg value="/property:Configuration=Debug" if="${debug}" />
      <arg value="/property:Configuration=Release" if="${ship}" />
      <arg value="/property:Platform=Any CPU" />
      <arg value="/target:Build" />
      <arg file="${dir.wixroot.test}\MigrateQTests\MigrateQTests.csproj" />
    </exec>
    <exec program="migrateQTests.exe" basedir="${dir.target.project.x86}" failonerror="true">
      <arg file="${dir.wixroot}\examples\test\tests.xml" />
      <arg file="${dir.wixroot.test}\src\QTests\AutoGeneratedQTests.cs" />
    </exec>
  </target>
  <target name="wixtestsmain.inc" depends="core, dtf, toolsrc, ext" if="${property::exists('netfx4full')}" description="Performs an incremental build">
    <if test="${property::exists('vstesttools.installed') and property::exists('netfx4full.installed')}">
      <exec program="msbuild.exe" basedir="${netfx4full}" failonerror="true">
        <arg value="/property:Configuration=Debug" if="${debug}" />
        <arg value="/property:Configuration=Release" if="${ship}" />
        <arg value="/property:Platform=Any CPU" />
        <arg value="/target:Build" />
        <arg file="${dir.wixroot.test}\wixtests.sln" />
      </exec>
    </if>
  </target>
  
  
  <!--
  //////////////////////////////////////////////////////////////////////////////////////////////////
  // Test Execution 
  //////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  
  <!-- Properties -->
  <property name="dir.wixroot.qtest" value="${dir.wixroot}\examples\test" readonly="true" />
  <property name="testarea" value="*" />
  <property name="enableruntimetests" value="false" />
  <property name="measurecodecoverage" value="false" />
  <property name="runbvts" value="${ship and property::exists('vstesttools.installed')}" />
  
  <!-- Build -->
  <target name="runtests" depends="wixtests" description="Run Wix tests">
     <exec program="test.bat" basedir="${dir.wixroot.test}" workingdir="${dir.wixroot.test}" failonerror="true">
      <arg value="debug" if="${debug}" />
      <arg value="ship" if="${ship}" />
      <arg value="-enableruntimetests" if="${enableruntimetests}" />
      <arg value="-measurecodecoverage" if="${measurecodecoverage}" />
      <arg line="-area ${testarea}" />
    </exec>
  </target>

  <target name="runbvts" depends="wixtests, zip" description="Run Wix bvt suite" if="${runbvts}">
     <exec program="test.bat" basedir="${dir.wixroot.test}" workingdir="${dir.wixroot.test}" failonerror="true">
      <arg value="debug" if="${debug}" />
      <arg value="ship" if="${ship}" />
      <arg line="-testlist &quot;${dir.wixroot.test}\BVTs.testlist&quot;" />
    </exec>
  </target>

  <target name="runsmoketests"  depends="core, dtf, toolsrc, ext" description="Run Wix smoke tests">
     <exec program="test.bat" basedir="${dir.wixroot.qtest}" workingdir="${dir.wixroot.qtest}" failonerror="true">
      <arg value="debug" if="${debug}" />
      <arg value="ship" if="${ship}" />
    </exec>
  </target>
 
</project>